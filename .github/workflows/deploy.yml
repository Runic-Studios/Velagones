name: Build and Publish Velagones

on:
  push:
    branches:
      - '**'

env:
  PROJECT_NAME: 'Velagones'
  ARTIFACT_VELOCITY_NAME: 'velagones-velocity'
  ARTIFACT_PAPER_NAME: 'velagones-paper'
  REGISTRY: 'registry.runicrealms.com'
  REGISTRY_PROJECT: 'library'

jobs:
  build-and-push:
    runs-on: rr-runner
    container:
      image: registry.runicrealms.com/agents/agent-java-21:latest
      credentials:
        username: ${{ secrets.HARBOR_USERNAME }}
        password: ${{ secrets.HARBOR_PASSWORD }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine Environment
        id: env
        uses: Runic-Studios/Realm-Actions/determine-env@main

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Build Artifacts
        run: ./gradlew :velocity:shadowJar :paper:shadowJar --no-daemon

      - name: Get Short SHA
        id: vars
        run: echo "sha_short=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT

      - name: Push Velocity Artifact
        uses: Runic-Studios/Realm-Actions/oras-push@main
        with:
          artifact_name: ${{ env.ARTIFACT_VELOCITY_NAME }}
          tag: ${{ steps.vars.outputs.sha_short }}
          file_path: 'velocity/build/libs/velagones-velocity-all.jar'
          registry: ${{ env.REGISTRY }}
          registry_project: ${{ env.REGISTRY_PROJECT }}
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}

      - name: Push Paper Artifact
        uses: Runic-Studios/Realm-Actions/oras-push@main
        with:
          artifact_name: ${{ env.ARTIFACT_PAPER_NAME }}
          tag: ${{ steps.vars.outputs.sha_short }}
          file_path: 'paper/build/libs/velagones-paper-all.jar'
          registry: ${{ env.REGISTRY }}
          registry_project: ${{ env.REGISTRY_PROJECT }}
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}

      - name: Update Realm-Velocity Manifest
        uses: Runic-Studios/Realm-Actions/update-manifest@main
        with:
          repository: 'Realm-Velocity'
          branch: 'dev'
          file_path: 'artifact-manifest.yaml'
          yq_path: '.artifacts["velagones"].tag'
          new_value: ${{ steps.vars.outputs.sha_short }}
          ssh_key: ${{ secrets.BOT_SSH_KEY }}
          commit_message: 'Update ${{ env.ARTIFACT_VELOCITY_NAME }} tag to ${{ steps.vars.outputs.sha_short }}'

      - name: Update Realm-Paper Manifest
        uses: Runic-Studios/Realm-Actions/update-manifest@main
        with:
          repository: 'Realm-Paper'
          branch: 'dev'
          file_path: 'artifact-manifest.yaml'
          yq_path: '.artifacts["velagones"].tag'
          new_value: ${{ steps.vars.outputs.sha_short }}
          ssh_key: ${{ secrets.BOT_SSH_KEY }}
          commit_message: 'Update ${{ env.ARTIFACT_PAPER_NAME }} tag to ${{ steps.vars.outputs.sha_short }}'

      - name: Publish to Maven Reposilite (Prod Only)
        if: steps.env.outputs.run_main_deploy == 'true'
        env:
          REPOSILITE_USERNAME: ${{ secrets.REPOSILITE_USERNAME }}
          REPOSILITE_PASSWORD: ${{ secrets.REPOSILITE_PASSWORD }}
        run: ./gradlew publish

      - name: Create PR Realm-Velocity (Prod Only)
        if: steps.env.outputs.run_main_deploy == 'true'
        uses: Runic-Studios/Realm-Actions/create-pr@main
        with:
          repository: 'Realm-Velocity'
          base: 'main'
          head: 'dev'
          title: 'AUTOGENERATED: Promote Velagones (Velocity) to production'
          body: 'Promote Velagones.'
          gh_token: ${{ secrets.BOT_PAT }}
          ssh_key: ${{ secrets.BOT_SSH_KEY }}

      - name: Create PR Realm-Paper (Prod Only)
        if: steps.env.outputs.run_main_deploy == 'true'
        uses: Runic-Studios/Realm-Actions/create-pr@main
        with:
          repository: 'Realm-Paper'
          base: 'main'
          head: 'dev'
          title: 'AUTOGENERATED: Promote Velagones (Paper) to production'
          body: 'Promote Velagones.'
          gh_token: ${{ secrets.BOT_PAT }}
          ssh_key: ${{ secrets.BOT_SSH_KEY }}
